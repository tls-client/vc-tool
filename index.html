<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VC Joiner</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #101018;
      --card: #20222b;
      --accent: #5865f2;
      --glow: #64d6ff;
      --danger: #ff5c5c;
      --text: #e1e3e8;
    }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #11131a; }
    ::-webkit-scrollbar-thumb { background: #5865f2; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--glow); }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: radial-gradient(ellipse at 60% 30%, #23253b 0%, #1a1b20 35%, var(--bg) 100%);
      color: var(--text);
      min-height: 100dvh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .card {
      background: var(--card);
      padding: 36px;
      border-radius: 20px;
      box-shadow: 0 15px 40px rgba(0,0,0,.7);
      width: 100%;
      max-width: 620px;
      animation: fadeIn .8s ease;
    }
    @keyframes fadeIn { from { opacity:0; transform:translateY(20px); } }

    h2 { color: var(--glow); text-align: center; margin-bottom: 28px; font-size: 28px; font-weight: 700; }

    label { display:block; margin-top:18px; font-size:14px; color:var(--glow); font-weight:600; }
    input[type=text] {
      width:100%; padding:12px; margin-top:6px;
      background:#15161b; border:none; border-radius:10px; color:#fff;
      font-family:'Courier New',monospace; font-size:14px;
    }
    input:focus { outline:none; box-shadow:0 0 0 3px rgba(100,214,255,.4); }

    .row { display:flex; gap:12px; margin-top:8px; flex-wrap:wrap; }
    button.secondary {
      padding:10px 18px; background:#2c2f38; color:var(--glow);
      border:1px solid var(--glow); border-radius:10px; cursor:pointer;
      transition:all .3s;
    }
    button.secondary:hover { background:var(--glow); color:#000; }

    .token-list {
      margin-top:12px; max-height:180px; overflow-y:auto;
      background:#15161b; border-radius:10px; padding:10px;
      border:1px solid rgba(100,214,255,.2);
    }
    .token-item {
      display:flex; justify-content:space-between; align-items:center;
      padding:8px 12px; background:rgba(100,214,255,.05);
      border-radius:8px; margin-bottom:6px; font-family:monospace; font-size:13px;
    }
    .token-item button {
      background:var(--danger); color:#fff; border:none;
      padding:4px 10px; border-radius:6px; font-size:12px; cursor:pointer;
    }

    .button-row {
      display: grid;
      grid-template-columns: 1fr 1fr;   /* ← 左右に均等に分割 */
      gap: 12px;
      margin-top: 10px;
    }
    
    @media (max-width: 480px) {
     .button-row {
       grid-template-columns: 1fr 1fr;
    }
  }
    
    .toggle-row {
      display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:16px; margin:28px 0;
    }
    .checkbox {
      display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none;
    }
    .checkbox input {
      appearance:none; width:40px; height:20px;
      background:#2a2c32; border-radius:20px; position:relative;
      transition:background .3s;
    }
    .checkbox input::before {
      content:''; position:absolute; width:16px; height:16px;
      background:#fff; border-radius:50%; top:2px; left:2px;
      transition:transform .3s cubic-bezier(.68,-.55,.27,1.55);
    }
    .checkbox input:checked { background:var(--glow); }
    .checkbox input:checked::before { transform:translateX(20px); }
    .checkbox span { transition:color .3s; }
    .checkbox input:checked + span { color:var(--glow); }

    button.primary {
      width:100%; padding:16px; margin-top:24px;
      border:none; border-radius:14px; font-weight:700; font-size:18px;
      color:#fff; cursor:pointer; transition:all .3s;
      position:relative; overflow:hidden;
    }
    #joinBtn { background:linear-gradient(135deg,#5865f2,var(--glow)); }
    #leaveBtn { background:linear-gradient(135deg,#ff5c5c,#c42b4e); margin-top:12px; }
    button.primary:hover { transform:translateY(-3px); box-shadow:0 10px 30px rgba(100,214,255,.6); }
    button.primary:disabled { opacity:.6; cursor:not-allowed; transform:none; }

    .progress { margin-top:12px; height:6px; background:#15161b; border-radius:3px; overflow:hidden; }
    .progress-bar { height:100%; width:0%; background:var(--glow); transition:width .4s; }

    .log {
      margin-top:20px; max-height:200px; overflow-y:auto;
      background:#15161b; border-radius:10px; padding:12px;
      font-family:monospace; font-size:13px; line-height:1.5;
    }
    .log .success { color:var(--glow); }
    .log .error { color:#ff6b6b; }
  </style>
</head>
<body>
  <div class="card">
    <h2>VC Joiner</h2>

    <label>Token</label>
    <input type="text" id="tokenInput" placeholder="改行で複数可">
    <div class="button-row">
    <button class="secondary" id="uploadBtn">ファイル読み込み</button>
    <button class="secondary" id="addBtn">追加</button>
    <input type="file" id="fileInput" style="display:none">
    </div>

    <div class="token-list" id="tokenList">
      <div style="text-align:center;color:#666;padding:20px">トークンがありません</div>
    </div>

    <label>Guild ID</label>
    <input type="text" id="guildId">

    <label>Voice Channel ID</label>
    <input type="text" id="channelId">

    <div class="toggle-row">
      <label class="checkbox"><input type="checkbox" id="cam"><span>Camera</span></label>
      <label class="checkbox"><input type="checkbox" id="mic"><span>Mic</span></label>
      <label class="checkbox"><input type="checkbox" id="deaf"><span>Speaker Mute</span></label>
      <label class="checkbox"><input type="checkbox" id="stream"><span>Stream</span></label>
    </div>

    <button class="primary" id="joinBtn">VC Join</button>
    <button class="primary" id="leaveBtn">VC Leave</button>

    <div class="progress"><div class="progress-bar" id="progress"></div></div>
    <div class="log" id="log"></div>
  </div>

<script>
class VCJoiner {
  constructor(token, guildId, channelId, options = {}) {
    this.token = token.trim();
    this.guildId = guildId;
    this.channelId = channelId;
    this.options = { camera: false, mic: true, deaf: false, stream: false, ...options };
    this.ws = null;
    this.heartbeat = null;
    this.connected = false;
  }

  async connect() {
    return new Promise((resolve, reject) => {
      this.ws = new WebSocket('wss://gateway.discord.gg/?v=9&encoding=json');

      const timeout = setTimeout(() => reject(new Error('Timeout')), 15000);

      this.ws.onmessage = (e) => {
        const p = JSON.parse(e.data);

        if (p.op === 10) { // Hello
          clearTimeout(timeout);
          this.heartbeat = setInterval(() => this.ws?.send(JSON.stringify({ op: 1, d: null })), p.d.heartbeat_interval);

          this.ws.send(JSON.stringify({
            op: 2,
            d: { token: this.token, properties: { $os: "Windows", $browser: "Chrome", $device: "pc" }, intents: 0 }
          }));

          setTimeout(() => {
            this.ws.send(JSON.stringify({
              op: 4,
              d: {
                guild_id: this.guildId,
                channel_id: this.channelId,
                self_mute: !this.options.mic,
                self_deaf: this.options.deaf,
                self_video: this.options.camera,
                self_stream: this.options.stream
              }
            }));
            this.connected = true;
            resolve();
          }, 1500);
        }
      };

      this.ws.onerror = () => reject(new Error('WebSocket error'));
      this.ws.onclose = () => this.connected = false;
    });
  }

  updateSettings(options) {
    this.options = { ...this.options, ...options };
    if (this.connected && this.ws?.readyState === WebSocket.OPEN) {
      this.ws.send(JSON.stringify({
        op: 4,
        d: {
          guild_id: this.guildId,
          channel_id: this.channelId,
          self_mute: !this.options.mic,
          self_deaf: this.options.deaf,
          self_video: this.options.camera,
          self_stream: this.options.stream
        }
      }));
    }
  }

  disconnect() {
    if (this.ws) {
      this.ws.send(JSON.stringify({
        op: 4,
        d: { guild_id: this.guildId, channel_id: null, self_mute: true, self_deaf: false }
      }));
      setTimeout(() => this.ws?.close(), 300);
    }
    if (this.heartbeat) clearInterval(this.heartbeat);
    this.connected = false;
  }
}

class App {
  constructor() {
    this.tokens = new Set();
    this.clients = new Map(); // token → VCJoiner
    this.isRunning = false;

    this.elements = {
      tokenInput: document.getElementById('tokenInput'),
      addBtn: document.getElementById('addBtn'),
      uploadBtn: document.getElementById('uploadBtn'),
      fileInput: document.getElementById('fileInput'),
      tokenList: document.getElementById('tokenList'),
      guildId: document.getElementById('guildId'),
      channelId: document.getElementById('channelId'),
      cam: document.getElementById('cam'),
      mic: document.getElementById('mic'),
      deaf: document.getElementById('deaf'),
      stream: document.getElementById('stream'),
      joinBtn: document.getElementById('joinBtn'),
      leaveBtn: document.getElementById('leaveBtn'),
      progress: document.getElementById('progress'),
      log: document.getElementById('log')
    };

    this.bindEvents();
  }

  log(msg, type = 'info') {
    const time = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const line = document.createElement('div');
    line.className = `[${time}] ${msg}`;
    line.classList.add(type);
    this.elements.log.appendChild(line);
    this.elements.log.scrollTop = this.elements.log.scrollHeight;
  }

  updateProgress(current, total) {
    const percent = Math.round((current / total) * 100);
    this.elements.progress.style.width = `${percent}%`;
  }

  getSettings() {
    return {
      camera: this.elements.cam.checked,
      mic: this.elements.mic.checked,
      deaf: this.elements.deaf.checked,
      stream: this.elements.stream.checked
    };
  }

  addToken(token) {
    token = token.trim();
    if (!token || !token.includes('.') || this.tokens.has(token)) return false;
    this.tokens.add(token);
    const item = document.createElement('div');
    item.className = 'token-item';
    item.innerHTML = `<span>${token.slice(0,12)}...${token.slice(-8)}</span><button>削除</button>`;
    item.querySelector('button').onclick = () => {
      this.tokens.delete(token);
      item.remove();
    };
    this.elements.tokenList.appendChild(item);
    return true;
  }

  async start() {
    if (this.isRunning) return;
    const guildId = this.elements.guildId.value.trim();
    const channelId = this.elements.channelId.value.trim();
    if (!guildId || !channelId) return this.log('サーバーIDまたはチャンネルIDが空です', 'error');
    if (this.tokens.size === 0) return this.log('トークンがありません', 'error');

    this.isRunning = true;
    this.elements.joinBtn.disabled = true;
    this.elements.joinBtn.textContent = '参加中...';
    this.elements.progress.style.width = '0%';

    const settings = this.getSettings();
    let success = 0;

    for (const [i, token] of [...this.tokens].entries()) {
      try {
        const client = new VCJoiner(token, guildId, channelId, settings);
        await client.connect();
        this.clients.set(token, client);
        success++;
        this.log(`Success: ${token.slice(0,12)}...`, 'success');
      } catch (e) {
        this.log(`Failed: ${token.slice(0,12)}...`, 'error');
      }
      this.updateProgress(i + 1, this.tokens.size);
      await new Promise(r => setTimeout(r, 900 + Math.random() * 800)); // レートリミット回避
    }

    this.isRunning = false;
    this.elements.joinBtn.disabled = false;
    this.elements.joinBtn.textContent = 'VCに参加';
    this.log(`完了: ${success}/${this.tokens.size} 成功`, 'success');
  }

  stop() {
    this.clients.forEach(client => client.disconnect());
    this.clients.clear();
    this.log('全員退出しました', 'success');
  }

  bindEvents() {
    this.elements.addBtn.onclick = () => {
      const token = this.elements.tokenInput.value;
      if (this.addToken(token)) this.elements.tokenInput.value = '';
    };

    this.elements.uploadBtn.onclick = () => this.elements.fileInput.click();
    this.elements.fileInput.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const lines = ev.target.result.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
        let added = 0;
        lines.forEach(t => { if (this.addToken(t)) added++; });
        this.log(`ファイルから ${added} 個のトークンを追加`, 'success');
      };
      reader.readAsText(file);
    };

    this.elements.joinBtn.onclick = () => this.start();
    this.elements.leaveBtn.onclick = () => this.stop();

    // リアルタイム設定反映
    ['cam','mic','deaf','stream'].forEach(id => {
      document.getElementById(id).onchange = () => {
        const newSettings = this.getSettings();
        this.clients.forEach(client => client.updateSettings(newSettings));
      };
    });
  }
}

// 起動
new App();
</script>
</body>
</html>
