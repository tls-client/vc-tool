<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VC Joiner</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d0e15;
      --card: #14151e;
      --card-glass: rgba(20, 21, 30, 0.65);
      --accent: #5865f2;
      --glow: #64d6ff;
      --glow-strong: #80e8ff;
      --danger: #ff5c5c;
      --text: #e8eaed;
      --text-muted: #9ba1b0;
      --border: rgba(100, 214, 255, 0.15);
      --shadow: 0 8px 32px rgba(0,0,0,0.6);
      --radius: 20px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: radial-gradient(ellipse at 60% 30%, #23253b 0%, #1a1b20 40%, var(--bg) 100%);
      color: var(--text);
      min-height: 100dvh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(10px);
    }

    .card {
      background: var(--card-glass);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      padding: 40px;
      border-radius: var(--radius);
      box-shadow: var(--shadow), 0 0 60px rgba(88, 101, 242, 0.15);
      width: 100%;
      max-width: 640px;
      animation: floatIn .9s ease-out;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; height: 2px;
      background: linear-gradient(90deg, transparent, var(--glow), transparent);
      animation: shimmer 4s infinite;
    }

    @keyframes floatIn { from { opacity:0; transform: translateY(40px) scale(0.96); } }
    @keyframes shimmer { 0%,100% { transform: translateX(-100%); } 50% { transform: translateX(100%); } }

    h2 {
      color: var(--glow-strong);
      text-align: center;
      margin-bottom: 32px;
      font-size: 32px;
      font-weight: 800;
      letter-spacing: -0.5px;
      text-shadow: 0 0 20px rgba(100,214,255,0.5);
    }

    label {
      display: block;
      margin-top: 20px;
      font-size: 14px;
      color: var(--glow);
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    /* すべてのテキスト入力欄を完全統一 */
    input[type="text"],
    textarea#tokenInput {
      width: 100%;
      padding: 14px 16px;
      margin-top: 8px;
      background: rgba(21,22,27,0.7);
      border: 1px solid var(--border);
      border-radius: 14px;
      color: #fff;
      font-family: 'Courier New', monospace;
      font-size: 15px;
      transition: var(--transition);
      backdrop-filter: blur(10px);
      resize: vertical;
    }

    input[type="text"]:focus,
    textarea#tokenInput:focus {
      outline: none;
      border-color: var(--glow);
      box-shadow: 0 0 0 4px rgba(100,214,255,0.2), 0 8px 25px rgba(100,214,255,0.15);
      background: rgba(21,22,27,0.9);
    }

    textarea#tokenInput {
      min-height: 120px;
    }

    .button-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 10px;
    }

    button.secondary {
      padding: 13px 20px;
      background: rgba(88,101,242,0.15);
      color: var(--glow);
      border: 1px solid rgba(100,214,255,0.3);
      border-radius: 14px;
      font-weight: 600;
      font-size: 14.5px;
      cursor: pointer;
      transition: var(--transition);
      backdrop-filter: blur(10px);
    }
    button.secondary:hover {
      background: var(--glow);
      color: #000;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(100,214,255,0.3);
    }

    .hidden-input { display: none; }

    .token-list {
      margin-top: 14px;
      max-height: 200px;
      overflow-y: auto;
      background: rgba(21,22,27,0.5);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      backdrop-filter: blur(10px);
    }

    .token-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: rgba(100,214,255,0.08);
      border-radius: 12px;
      margin-bottom: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13.5px;
      border: 1px solid transparent;
      transition: var(--transition);
    }
    .token-item:hover {
      border-color: var(--glow);
      transform: translateX(4px);
    }

    .token-item button {
      background: var(--danger);
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }
    .token-item button:hover { background: #ff6b6b; transform: scale(1.05); }

    .empty-state {
      text-align: center;
      color: var(--text-muted);
      padding: 32px 16px;
      font-size: 15px;
      font-weight: 500;
    }

    .toggle-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 18px;
      margin: 32px 0;
    }

    .checkbox {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      user-select: none;
      font-size: 15px;
      font-weight: 500;
    }
    .checkbox input {
      appearance: none;
      width: 48px; height: 26px;
      background: rgba(255,255,255,0.1);
      border-radius: 50px;
      position: relative;
      transition: var(--transition);
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.4);
    }
    .checkbox input::before {
      content: ''; position: absolute;
      width: 20px; height: 20px;
      background: linear-gradient(135deg, #fff, #f0f0f0);
      border-radius: 50%;
      top: 3px; left: 3px;
      transition: var(--transition);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .checkbox input:checked {
      background: linear-gradient(135deg, var(--accent), var(--glow));
    }
    .checkbox input:checked::before { transform: translateX(22px); }
    .checkbox input:checked + span { color: var(--glow-strong); }

    button.primary {
      width: 100%;
      padding: 18px;
      margin-top: 28px;
      border: none;
      border-radius: 16px;
      font-weight: 800;
      font-size: 18px;
      color: #fff;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }
    #joinBtn  { background: linear-gradient(135deg, #5865f2, #64d6ff); }
    #leaveBtn { background: linear-gradient(135deg, #ff5c5c, #ff2e5e); margin-top: 14px; }

    button.primary::before {
      content: ''; position: absolute; top: 0; left: -100%;
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: var(--transition);
    }
    button.primary:hover::before { left: 100%; }
    button.primary:hover:not(:disabled) {
      transform: translateY(-4px);
      box-shadow: 0 20px 50px rgba(88,101,242,0.5);
    }

    .progress {
      margin-top: 20px;
      height: 8px;
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
      overflow: hidden;
      box-shadow: inset 0 2px 6px rgba(0,0,0,0.3);
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--glow));
      border-radius: 4px;
      transition: width .6s ease;
      box-shadow: 0 0 20px rgba(100,214,255,0.6);
    }

    .log {
      margin-top: 24px;
      max-height: 220px;
      overflow-y: auto;
      background: rgba(21,22,27,0.5);
      border-radius: 16px;
      padding: 16px;
      font-family: 'Courier New', monospace;
      font-size: 13.5px;
      line-height: 1.7;
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
    }
    .log-line { margin-bottom: 6px; }
    .log-line.success { color: var(--glow-strong); }
    .log-line.error   { color: #ff6b9d; }
    .log-line.info    { color: #aaa; }

    @media (max-width: 480px) {
      .card { padding: 28px 24px; }
      h2 { font-size: 28px; }
      .button-row { grid-template-columns: 1fr; }
      .toggle-row { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>VC Joiner</h2>

    <label>トークン（改行で複数可）</label>
    <textarea id="tokenInput" placeholder="ここにトークンを貼り付けてください&#10;1行に1トークン&#10;最大1000個まで対応"></textarea>

    <div class="button-row">
      <button class="secondary" id="uploadBtn">ファイル読み込み</button>
      <button class="secondary" id="addBtn">追加する</button>
    </div>
    <input type="file" id="fileInput" class="hidden-input" accept=".txt">

    <div class="token-list" id="tokenList">
      <div class="empty-state">トークンを追加してください</div>
    </div>

    <label>サーバーID</label>
    <input type="text" id="guildId" placeholder="例: 123456789012345678">

    <label>ボイスチャンネルID</label>
    <input type="text" id="channelId" placeholder="例: 987654321098765432">

    <div class="toggle-row">
      <label class="checkbox"><input type="checkbox" id="cam"><span>カメラ</span></label>
      <label class="checkbox"><input type="checkbox" id="mic" checked><span>マイク</span></label>
      <label class="checkbox"><input type="checkbox" id="deaf"><span>スピーカーミュート</span></label>
      <label class="checkbox"><input type="checkbox" id="stream"><span>配信</span></label>
    </div>

    <button class="primary" id="joinBtn">VCに参加</button>
    <button class="primary" id="leaveBtn">VCから退出</button>

    <div class="progress"><div class="progress-bar" id="progress"></div></div>
    <div class="log" id="log"></div>
  </div>

<script>
/* ============================================= */
/*               ユーティリティ関数               */
/* ============================================= */
const isValidToken = (t) => /^[\w-]{24}\.[\w-]{6}\.[\w-]{27}$/.test(t.trim()) || /^mfa\.[A-Za-z0-9_-]{84}$/.test(t.trim());
const delay = ms => new Promise(r => setTimeout(r, ms));
const randomDelay = (base = 900, variation = 800) => delay(base + Math.random() * variation);

/* ============================================= */
/*               VCJoiner クラス                  */
/* ============================================= */
class VCJoiner {
  constructor(token, guildId, channelId, options = {}) {
    this.token = token.trim();
    this.guildId = guildId;
    this.channelId = channelId;
    this.options = { camera: false, mic: true, deaf: false, stream: false, ...options };
    this.ws = null;
    this.heartbeat = null;
    this.connected = false;
  }

  async connect() {
    return new Promise((resolve, reject) => {
      const ws = new WebSocket('wss://gateway.discord.gg/?v=9&encoding=json');
      this.ws = ws;
      const timeout = setTimeout(() => reject(new Error('Gateway timeout')), 15000);

      ws.onmessage = e => {
        const p = JSON.parse(e.data);
        if (p.op === 10) {
          clearTimeout(timeout);
          this.heartbeat = setInterval(() => ws.send(JSON.stringify({ op: 1, d: null })), p.d.heartbeat_interval);
          ws.send(JSON.stringify({ op: 2, d: { token: this.token, properties: { $os: "Windows", $browser: "Chrome", $device: "pc" } } }));
          setTimeout(() => { this._sendVoiceState(); this.connected = true; resolve(); }, 1500);
        }
      };
      ws.onerror = () => reject(new Error('WebSocket error'));
    });
  }

  _sendVoiceState() {
    if (!this.ws || this.ws.readyState !== WebSocket.OPEN) return;
    this.ws.send(JSON.stringify({
      op: 4, d: {
        guild_id: this.guildId,
        channel_id: this.channelId,
        self_mute: !this.options.mic,
        self_deaf: this.options.deaf,
        self_video: this.options.camera,
        self_stream: this.options.stream
      }
    }));
  }

  updateSettings(opts) { this.options = { ...this.options, ...opts }; this._sendVoiceState(); }
  disconnect() {
    if (this.ws) {
      this.ws.send(JSON.stringify({ op: 4, d: { guild_id: this.guildId, channel_id: null, self_mute: true, self_deaf: false } }));
      setTimeout(() => this.ws?.close(), 300);
    }
    clearInterval(this.heartbeat);
    this.connected = false;
  }
}

/* ============================================= */
/*                  App クラス                    */
/* ============================================= */
class App {
  constructor() {
    this.tokens = new Set();
    this.clients = new Map();
    this.isRunning = false;

    this.el = {
      tokenInput: document.getElementById('tokenInput'),
      uploadBtn:  document.getElementById('uploadBtn'),
      addBtn:     document.getElementById('addBtn'),
      fileInput:  document.getElementById('fileInput'),
      tokenList:  document.getElementById('tokenList'),
      guildId:    document.getElementById('guildId'),
      channelId:  document.getElementById('channelId'),
      cam:        document.getElementById('cam'),
      mic:        document.getElementById('mic'),
      deaf:       document.getElementById('deaf'),
      stream:     document.getElementById('stream'),
      joinBtn:    document.getElementById('joinBtn'),
      leaveBtn:   document.getElementById('leaveBtn'),
      progress:   document.getElementById('progress'),
      log:        document.getElementById('log')
    };

    this.bindEvents();
  }

  log(msg, type = 'info') {
    const time = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const line = document.createElement('div');
    line.className = `log-line ${type}`;
    line.textContent = `[${time}] ${msg}`;
    this.el.log.appendChild(line);
    this.el.log.scrollTop = this.el.log.scrollHeight;
  }

  updateProgress(cur, total) {
    this.el.progress.style.width = `${Math.round((cur / total) * 100)}%`;
  }

  getSettings() {
    return {
      camera: this.el.cam.checked,
      mic:    this.el.mic.checked,
      deaf:   this.el.deaf.checked,
      stream: this.el.stream.checked
    };
  }

  // 複数トークン一括追加（改行・ファイル・Enterキー対応）
  addTokensFromText(inputValue) {
    if (!inputValue.trim()) return 0;
    const lines = inputValue.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    let addedCount = 0;

    lines.forEach(token => {
      if (!isValidToken(token)) {
        this.log(`無効なトークン: ${token.slice(0,12)}...`, 'error');
        return;
      }
      if (this.tokens.has(token)) {
        this.log(`重複スキップ: ${token.slice(0,12)}...`, 'info');
        return;
      }

      this.tokens.add(token);
      const item = document.createElement('div');
      item.className = 'token-item';
      item.dataset.token = token;
      item.innerHTML = `<span>${token.slice(0, 12)}...${token.slice(-8)}</span><button data-action="remove">削除</button>`;
      this.el.tokenList.appendChild(item);
      addedCount++;
    });

    if (addedCount > 0) {
      this.el.tokenInput.value = '';
      this.log(`トークンを ${addedCount} 個追加しました`, 'success');
    }
    return addedCount;
  }

  removeToken(token) {
    this.tokens.delete(token);
    this.clients.get(token)?.disconnect();
    this.clients.delete(token);
    document.querySelector(`[data-token="${token}"]`)?.remove();
    if (this.tokens.size === 0) {
      this.el.tokenList.innerHTML = '<div class="empty-state">トークンを追加してください</div>';
    }
  }

  async start() {
    if (this.isRunning) return;
    const guildId = this.el.guildId.value.trim();
    const channelId = this.el.channelId.value.trim();
    if (!guildId || !channelId) return this.log('サーバーIDまたはチャンネルIDが未入力です', 'error');
    if (this.tokens.size === 0) return this.log('トークンがありません', 'error');

    this.isRunning = true;
    this.el.joinBtn.disabled = true;
    this.el.joinBtn.textContent = '参加中...';
    this.el.progress.style.width = '0%';

    const settings = this.getSettings();
    let success = 0;

    for (const [i, token] of Array.from(this.tokens).entries()) {
      try {
        const client = new VCJoiner(token, guildId, channelId, settings);
        await client.connect();
        this.clients.set(token, client);
        success++;
        this.log(`成功: ${token.slice(0,12)}...`, 'success');
      } catch (err) {
        console.error('[VC Joiner] Connection failed:', err);
        this.log(`失敗: ${token.slice(0,12)}...`, 'error');
      }
      this.updateProgress(i + 1, this.tokens.size);
      await randomDelay();
    }

    this.isRunning = false;
    this.el.joinBtn.disabled = false;
    this.el.joinBtn.textContent = 'VCに参加';
    this.log(`完了: ${success}/${this.tokens.size} アカウント参加`, 'success');
  }

  stop() {
    this.clients.forEach(c => c.disconnect());
    this.clients.clear();
    this.log('全員退出しました', 'success');
  }

  bindEvents() {
    this.el.addBtn.addEventListener('click', () => this.addTokensFromText(this.el.tokenInput.value));

    // Enterで追加（Shift+Enterで改行）
    this.el.tokenInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        this.addTokensFromText(this.el.tokenInput.value);
      }
    });

    // ファイル読み込み
    this.el.uploadBtn.addEventListener('click', () => this.el.fileInput.click());
    this.el.fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        this.addTokensFromText(ev.target.result);
      };
      reader.readAsText(file);
    });

    this.el.joinBtn.addEventListener('click', () => this.start());
    this.el.leaveBtn.addEventListener('click', () => this.stop());

    this.el.tokenList.addEventListener('click', e => {
      if (e.target.matches('[data-action="remove"]')) {
        const token = e.target.closest('.token-item').dataset.token;
        this.removeToken(token);
      }
    });

    ['cam', 'mic', 'deaf', 'stream'].forEach(id => {
      this.el[id].addEventListener('change', () => {
        const newSettings = this.getSettings();
        this.clients.forEach(client => client.updateSettings(newSettings));
      });
    });
  }
}

const app = new App();
</script>
</body>
</html>
